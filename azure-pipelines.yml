# azure-pipelines.yml
# Pipeline สำหรับ Build, Push Docker Image ไป ACR, และ Deploy ไป Azure Container Apps

trigger:
- main # กำหนดให้รันเมื่อมีการ push ไปที่ branch main

variables:
  # *** ต้องตั้งค่าตัวแปรเหล่านี้ใน Azure DevOps Pipeline UI ***
  
  # ชื่อ Connection Service ใน Azure DevOps ที่เชื่อมต่อกับ Azure Subscription
  azureSubscription: 'ITALOT-DEV' 
  
  # ชื่อ Azure Container Registry (ACR) ของคุณ
  acrName: 'acraz2003cahlab.azurecr.io' 
  
  # ชื่อ Resource Group ที่ Azure Container App อยู่
  resourceGroup: 'lab-aca' 
  
  # ชื่อ Azure Container App ที่จะทำการ Deploy
  containerAppName: 'aca-az2003'
  
  # Image Name และ Tag ที่จะใช้ (ใช้ Build ID เป็น Tag)
  imageRepository: 'hello-world'
  imageTag: '$(Build.BuildId)'
  
  # พอร์ตที่แอปพลิเคชันรันอยู่ภายใน Container (ตรงกับ EXPOSE ใน Dockerfile)
  containerAppTargetPort: '8080'

stages:
- stage: BuildAndPush
  displayName: 'Build and Push Docker Image to ACR'
  jobs:
  - job: Build
    displayName: 'Docker Build and Push'
    pool:
      vmImage: 'ubuntu-latest' # ใช้ Agent ที่เป็น Ubuntu

    steps:
    - task: Docker@2
      displayName: 'Build and push the image to ACR'
      inputs:
        command: buildAndPush
        # เชื่อมต่อกับ ACR โดยใช้ Service Connection
        containerRegistry: $(acrName) 
        repository: $(imageRepository)
        tags: |
          $(imageTag)
          latest
        # ไฟล์ Dockerfile ที่จะใช้ (อยู่ใน root directory)
        dockerfile: '$(Build.SourcesDirectory)/Dockerfile'
        # Context (ใช้ root directory)
        buildContext: '$(Build.SourcesDirectory)'
        # เชื่อมต่อกับ Azure Subscription เพื่อใช้ ACR
        azureSubscription: $(azureSubscription)

    - task: PublishPipelineArtifact@1
      displayName: 'Publish Image Tag Artifact'
      inputs:
        targetPath: '$(Build.SourcesDirectory)'
        artifact: 'Manifest'
        # บันทึก Image Tag เพื่อใช้ใน Stage ถัดไป
        contents: |
          $(imageRepository):$(imageTag)
          
- stage: Deploy
  displayName: 'Deploy to Azure Container Apps'
  dependsOn: BuildAndPush
  condition: succeeded()
  jobs:
  - deployment: DeployContainerApp
    displayName: 'Deploy Container App'
    environment: 'ACA-Deployment' # ชื่อ Environment ที่คุณกำหนดใน Azure DevOps
    pool:
      vmImage: 'ubuntu-latest'

    strategy:
      runOnce:
        deploy:
          steps:
          - task: DownloadPipelineArtifact@2
            displayName: 'Download Image Tag Artifact'
            inputs:
              artifact: 'Manifest'
              path: '$(Pipeline.Workspace)/Manifest'

          - script: |
              # อ่าน Image Path/Tag จาก Artifact
              imageFullPath=$(cat $(Pipeline.Workspace)/Manifest/$(imageRepository):$(imageTag))
              echo "##vso[task.setvariable variable=fullImageName]$imageFullPath"
            displayName: 'Set Full Image Name Variable'

          - task: AzureContainerApps@1
            displayName: 'Deploy Azure Container App'
            inputs:
              # Service Connection ที่มีสิทธิ์ในการจัดการ Container App
              azureSubscription: $(azureSubscription) 
              resourceGroup: $(resourceGroup)
              containerAppName: $(containerAppName)
              
              # Image ที่ดึงมาจาก ACR
              imageToDeploy: '$(acrName).azurecr.io/$(imageRepository):$(imageTag)'
              
              # ตั้งค่า Target Port
              targetPort: $(containerAppTargetPort)
              
              # ตั้งค่า Environment Variable ใน Container (ถ้าต้องการ)
              environmentVariables: |
                CONTAINER_APP_NAME: $(containerAppName)
                
              # ตั้งค่าการเข้าถึง Registry โดยใช้ ACR
              registryUsername: $(acrName) # ใช้ชื่อ ACR เป็น Username
              registryPassword: '$(System.AccessToken)' # ใช้ Token ของ Service Connection (ต้องเปิดสิทธิ์)
              
              # ตั้งค่าการสร้าง Revision ใหม่ (แนะนำสำหรับ CI/CD)
              # trafficWeights: '[{ "latestRevision": true, "weight": 100 }]' # ถ้าต้องการจัดการ Traffic
              
              # ต้องเปิดใช้ Service Connection Authorization ใน Job/Stage

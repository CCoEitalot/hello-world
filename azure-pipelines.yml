# azure-pipelines.yml
# Pipeline สำหรับ Build และ Push Docker Image ไป ACR เท่านั้น

trigger:
- main # กำหนดให้รันเมื่อมีการ push ไปที่ branch main

variables:
  # *** IMPORTANT: ตัวแปรเหล่านี้ต้องถูกตั้งค่าใน Azure DevOps Pipeline UI ***
  
  # ชื่อ Service Connection หลัก (ชนิด: Azure Resource Manager)
  # ใช้สำหรับให้สิทธิ์ Agent ในการ Login เข้า ACR ผ่าน AzureRM
  # ต้องเป็นชื่อ Service Connection ที่คุณสร้างขึ้นมาจริงๆ (เช่น 'azureSubscription' ตามที่ตั้งค่าในภาพ)
  azureSubscription: 'azureSubscription' 
  
  # 1. ชื่อ Service Connection สำหรับ Docker Registry (ชนิด: Docker Registry)
  acrRegistryName: 'acr-lab-aca' 
  
  # 2. ACR Login Server Domain
  acrLoginServer: 'acraz2003cahlab.azurecr.io'
  
  # Image Name และ Tag ที่จะใช้
  imageRepository: 'hello-world'
  imageTag: '$(Build.BuildId)'
  
  # ตัวแปร Deploy อื่นๆ ที่ไม่ใช้แล้ว แต่คงไว้เผื่อต้องการกลับมาใช้
  resourceGroup: 'lab-aca' 
  containerAppName: 'aca-az2003'
  containerAppTargetPort: '8080'

stages:
- stage: BuildAndPush
  displayName: 'Build and Push Docker Image to ACR'
  jobs:
  - job: Build
    displayName: 'Docker Build and Push'
    pool:
      name: Azure Pipelines 
      vmImage: 'ubuntu-latest' 

    steps:
    - task: Docker@2
      displayName: 'Build and push the image to ACR'
      inputs:
        command: buildAndPush
        # Service Connection สำหรับ Docker Registry (acr-lab-aca) ใช้ในการระบุ Registry
        containerRegistry: $(acrRegistryName) 
        repository: $(imageRepository)
        tags: |
          $(imageTag)
          latest
        dockerfile: '$(Build.SourcesDirectory)/Dockerfile'
        buildContext: '$(Build.SourcesDirectory)'
        # Service Connection สำหรับสิทธิ์ Azure ทั่วไป (AzureRM) ใช้ในการ Login
        azureSubscription: $(azureSubscription)

    # Task นี้ถูกคงไว้เผื่อการใช้งานในอนาคต (Stage Deploy)
    - task: PublishPipelineArtifact@1
      displayName: 'Publish Image Tag Artifact'
      inputs:
        targetPath: '$(Build.SourcesDirectory)'
        artifact: 'Manifest'
        contents: |
          $(imageRepository):$(imageTag)

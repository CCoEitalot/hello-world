# azure-pipelines.yml

trigger:
- main 

variables:
  # ชื่อ Service Connection หลัก (ชนิด: Azure Resource Manager) 
  azureSubscription: 'azureSubscription' 
  
  # 1. ชื่อ Service Connection สำหรับ Docker Registry (ชนิด: Docker Registry)
  acrRegistryName: 'acr-lab-aca' 
  
  # 2. ACR Login Server Domain (แก้ไข: ลบ .azurecr.io ออก เพื่อหลีกเลี่ยงชื่อซ้ำซ้อนใน AzureContainerApps Task)
  acrLoginServer: 'acraz2003cahlab' 
  
  # ชื่อ Repository และ Tag
  imageRepository: 'hello-world'
  imageTag: '$(Build.BuildId)' 
  commitShortHash: $[substring(variables['Build.SourceVersion'], 0, 7)]
  
  # ตัวแปร Deploy
  resourceGroup: 'lab-aca' 
  containerAppName: 'aca-az2003' 
  containerAppTargetPort: '8080'
  
  # ชื่อไฟล์สำหรับ Artifact
  commitIdFileName: 'COMMIT_ID.txt' 

  deploymentLocation: 'southeastasia'

stages:
- stage: BuildAndPush
  displayName: 'Build and Push Docker Image to ACR (Standard)'
  jobs:
  - job: Build
    displayName: 'Docker Build and Push'
    pool:
      name: Default 
      
    steps:
    
    # 0. สร้างไฟล์สำหรับเก็บ Commit ID ก่อน Publish Artifact
    - script: |
        mkdir -p $(Pipeline.Workspace)/manifest
        echo "$(commitShortHash)" > $(Pipeline.Workspace)/manifest/$(commitIdFileName)
      displayName: 'Create Commit ID File for Artifact'
    
    # 1. Build และ Push Image
    - task: Docker@2
      displayName: 'Build and push the image to ACR'
      inputs:
        command: buildAndPush
        containerRegistry: $(acrRegistryName) 
        repository: $(imageRepository)
        tags: |
          $(commitShortHash)
          latest
        dockerfile: '$(Build.SourcesDirectory)/Dockerfile'
        buildContext: '$(Build.SourcesDirectory)'
        azureSubscription: $(azureSubscription)
        
    # 2. Publish Commit ID เป็น Artifact
    - task: PublishPipelineArtifact@1
      displayName: 'Publish Image Tag Artifact (Commit ID)'
      inputs:
        targetPath: '$(Pipeline.Workspace)/manifest' 
        artifact: 'Manifest'

- stage: Deploy
  displayName: 'Deploy to Azure Container Apps'
  dependsOn: BuildAndPush
  condition: succeeded()
  jobs:
  - deployment: DeployContainerApp
    displayName: 'Deploy Container App: aca-az2003'
    environment: ACA-Deployment
    
    pool:
      name: Default 

    strategy:
      runOnce:
        deploy:
          steps:
          - task: DownloadPipelineArtifact@2
            displayName: 'Download Commit ID Artifact'
            inputs:
              artifact: 'Manifest'
              
          - script: |
              commitId=$(cat $(Pipeline.Workspace)/Manifest/$(commitIdFileName))
              fullImageName="$(acrLoginServer).azurecr.io/$(imageRepository):$commitId"
              echo "##vso[task.setvariable variable=fullImageName]$fullImageName"
              echo "Deploying image: $fullImageName"
            displayName: 'Set Full Image Name Variable'
            env:
              commitIdFileName: $(commitIdFileName)
            
          - task: AzureContainerApps@1
            displayName: 'Deploy Azure Container App'
            inputs:
              azureSubscription: $(azureSubscription) 
              resourceGroup: $(resourceGroup)
              containerAppName: $(containerAppName)
              location: $(deploymentLocation)
              imageToDeploy: $(fullImageName)
              targetPort: $(containerAppTargetPort)
              environmentVariables: |
                CONTAINER_APP_NAME=$(containerAppName)
                IMAGE_COMMIT_ID=$(commitShortHash)
              acrName: $(acrLoginServer) 
              serviceConnectionAcr: $(azureSubscription)

          - task: AzureCLI@2
            displayName: 'Force 100% Traffic to Latest Revision'
            inputs:
              azureSubscription: $(azureSubscription)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "Attempting to retrieve the latest Revision Name..."
                
                # *** แก้ไข: เพิ่มการจัดเรียงตาม createdTime ใน Query ***
                LATEST_REVISION=$(az containerapp revision list \
                  --name $(containerAppName) \
                  --resource-group $(resourceGroup) \
                  --query "sort_by(@, &properties.createdTime)[-1].name" \
                  --output tsv)

                echo "Latest Revision Name Retrieved: $LATEST_REVISION"

                if [ -z "$LATEST_REVISION" ]; then
                  echo "##[error]Could not find the latest revision name. Aborting traffic update."
                  exit 1
                fi

                # กำหนด Traffic: ให้ Revision ล่าสุดรับ 100%
                echo "Setting 100% traffic to $LATEST_REVISION..."
                az containerapp ingress traffic set \
                  --name $(containerAppName) \
                  --resource-group $(resourceGroup) \
                  --revision-weight "$LATEST_REVISION=100"
                  
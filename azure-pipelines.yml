# azure-pipelines.yml
# Pipeline สำหรับ Build, Push Docker Image ไป ACR, และ Deploy ไป Azure Container Apps

trigger:
- main # กำหนดให้รันเมื่อมีการ push ไปที่ branch main

variables:
  # *** ต้องตั้งค่าตัวแปรเหล่านี้ใน Azure DevOps Pipeline UI ***
  
  # ชื่อ Connection Service ใน Azure DevOps ที่เชื่อมต่อกับ Azure Subscription
  # ถ้าITALOT-DEVมีปัญหา ให้เปลี่ยนค่านี้เป็นชื่อ Service Connection ที่ถูกต้อง
  azureSubscription: 'acr-lab-aca' 
  
  # 1. ชื่อ Service Connection สำหรับ Docker Registry
  acrRegistryName: 'acr-lab-aca' 
  
  # 2. ACR Login Server Domain
  acrLoginServer: 'acraz2003cahlab.azurecr.io'
  
  # ชื่อ Resource Group
  resourceGroup: 'lab-aca' 
  
  # ชื่อ Azure Container App
  containerAppName: 'aca-az2003'
  
  # Image Name และ Tag
  imageRepository: 'hello-world'
  imageTag: '$(Build.BuildId)'
  
  # พอร์ตที่แอปพลิเคชันรันอยู่ภายใน Container
  containerAppTargetPort: '8080'

stages:
- stage: BuildAndPush
  displayName: 'Build and Push Docker Image to ACR'
  jobs:
  - job: Build
    displayName: 'Docker Build and Push'
    pool:
      name: Azure Pipelines 
      vmImage: 'ubuntu-latest' 

    steps:
    - task: Docker@2
      displayName: 'Build and push the image to ACR'
      inputs:
        command: buildAndPush
        # Service Connection สำหรับ Docker Registry
        containerRegistry: $(acrRegistryName) 
        repository: $(imageRepository)
        tags: |
          $(imageTag)
          latest
        dockerfile: '$(Build.SourcesDirectory)/Dockerfile'
        buildContext: '$(Build.SourcesDirectory)'
        # Service Connection สำหรับสิทธิ์ Azure ทั่วไป (ต้องมี Contributor)
        azureSubscription: $(azureSubscription)

    - task: PublishPipelineArtifact@1
      displayName: 'Publish Image Tag Artifact'
      inputs:
        targetPath: '$(Build.SourcesDirectory)'
        artifact: 'Manifest'
        contents: |
          $(imageRepository):$(imageTag)
          
- stage: Deploy
  displayName: 'Deploy to Azure Container Apps'
  dependsOn: BuildAndPush
  condition: succeeded()
  jobs:
  - deployment: DeployContainerApp
    displayName: 'Deploy Container App'
    environment: 'ACA-Deployment' 
    pool:
      name: Azure Pipelines 
      vmImage: 'ubuntu-latest'

    strategy:
      runOnce:
        deploy:
          steps:
          - task: DownloadPipelineArtifact@2
            displayName: 'Download Image Tag Artifact'
            inputs:
              artifact: 'Manifest'
              path: '$(Pipeline.Workspace)/Manifest'

          - script: |
              # อ่าน Image Path/Tag จาก Artifact
              imageFullPath=$(cat $(Pipeline.Workspace)/Manifest/$(imageRepository):$(imageTag))
              echo "##vso[task.setvariable variable=fullImageName]$imageFullPath"
            displayName: 'Set Full Image Name Variable'

          - task: AzureContainerApps@1
            displayName: 'Deploy Azure Container App'
            inputs:
              # Service Connection สำหรับสิทธิ์ Azure ทั่วไป (ต้องมี Contributor)
              azureSubscription: $(azureSubscription) 
              resourceGroup: $(resourceGroup)
              containerAppName: $(containerAppName)
              
              # Image Path ที่ถูกต้อง
              imageToDeploy: '$(acrLoginServer)/$(imageRepository):$(imageTag)'
              
              # ตั้งค่า Target Port
              targetPort: $(containerAppTargetPort)
              
              # ตั้งค่า Environment Variable ใน Container
              environmentVariables: |
                CONTAINER_APP_NAME: $(containerAppName)
              
              # ตั้งค่าการให้สิทธิ์ Container App ดึง Image จาก ACR
              acrName: $(acrLoginServer)
              serviceConnectionAcr: $(azureSubscription)

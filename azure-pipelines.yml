# azure-pipelines.yml
# Pipeline สำหรับ Build และ Push Docker Image ไป ACR เท่านั้น

trigger:
- main # กำหนดให้รันเมื่อมีการ push ไปที่ branch main

variables:
  # ... ตัวแปรต่างๆ ยังคงเหมือนเดิม
  azureSubscription: 'azureSubscription' 
  acrRegistryName: 'acr-lab-aca' 
  acrLoginServer: 'acraz2003cahlab.azurecr.io'
  imageRepository: 'hello-world'
  imageTag: '$(Build.BuildId)'
  
  # ตัวแปร Deploy อื่นๆ ที่ไม่ใช้แล้ว แต่คงไว้เผื่อต้องการกลับมาใช้
  resourceGroup: 'lab-aca' 
  containerAppName: 'aca-az2003'
  containerAppTargetPort: '8080'

stages:
- stage: BuildAndPush
  displayName: 'Build and Push Docker Image to ACR (x86)'
  jobs:
  - job: Build
    displayName: 'Docker Build and Push x86'
    pool:
      # *** ใช้ Agent Pool "Default" เพื่อหลีกเลี่ยงข้อจำกัด Parallelism ***
      name: Default 
      
    steps:
    
    # 1. Login to ACR (จำเป็นสำหรับ Push) - เปลี่ยนจาก AzurePowerShell@5 เป็น AzureCLI@2
    - task: AzureCLI@2
      displayName: 'Azure CLI Login to ACR'
      inputs:
        azureSubscription: $(azureSubscription)
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: 'az acr login --name $(acrLoginServer)'
        
    - task: Docker@2
      displayName: 'Build Image for x86'
      inputs:
        command: build
        containerRegistry: $(acrRegistryName) 
        repository: $(imageRepository)
        tags: |
          $(imageTag)-x86
        dockerfile: '$(Build.SourcesDirectory)/Dockerfile'
        buildContext: '$(Build.SourcesDirectory)'
        # *** ระบุ Platform (x86) ***
        arguments: '--platform linux/386'
        
    - task: Docker@2
      displayName: 'Push Image to ACR'
      inputs:
        command: push
        containerRegistry: $(acrRegistryName) 
        repository: $(imageRepository)
        tags: |
          $(imageTag)-x86
          
    # Task สำหรับ Publish Image Tag เพื่อใช้ใน Stage Deploy (ถ้าจะใช้)
    - task: PublishPipelineArtifact@1
      displayName: 'Publish Image Tag Artifact'
      inputs:
        targetPath: '$(Build.SourcesDirectory)'
        artifact: 'Manifest'
        contents: |
          $(imageRepository):$(imageTag)-x86

          
# - stage: Deploy
#   displayName: 'Deploy to Azure Container Apps'
#   dependsOn: BuildAndPush
#   condition: succeeded()
#   jobs:
#   - deployment: DeployContainerApp
#     displayName: 'Deploy Container App'
#     environment: $(environmentName) # ใช้ Environment ที่กำหนด
#     pool:
#       name: Azure Pipelines 
#       vmImage: 'Default'

#     strategy:
#       runOnce:
#         deploy:
#           steps:
#           # 1. Download Artifact ที่เก็บ Image Tag
#           - task: DownloadPipelineArtifact@2
#             displayName: 'Download Image Tag Artifact'
#             inputs:
#               artifact: 'Manifest'
#               path: '$(Pipeline.Workspace)/Manifest'

#           # 2. ตั้งค่า Full Image Name Variable
#           - script: |
#               # อ่าน Image Path/Tag จาก Artifact
#               imageFullPath=$(cat $(Pipeline.Workspace)/Manifest/$(imageRepository):$(imageTag))
#               echo "##vso[task.setvariable variable=fullImageName]$imageFullPath"
#             displayName: 'Set Full Image Name Variable'

#           # 3. Deploy ไป Azure Container App
#           - task: AzureContainerApps@1
#             displayName: 'Deploy Azure Container App'
#             inputs:
#               # Service Connection สำหรับสิทธิ์ Azure ทั่วไป (AzureRM)
#               azureSubscription: $(azureSubscription) 
#               resourceGroup: $(resourceGroup)
#               containerAppName: $(containerAppName)
              
#               # Image Path ที่ถูกต้อง (Full Domain/Repository:Tag)
#               imageToDeploy: '$(acrLoginServer)/$(imageRepository):$(imageTag)'
              
#               # ตั้งค่า Target Port (ตามที่กำหนดใน Dockerfile)
#               targetPort: $(containerAppTargetPort)
              
#               # ตั้งค่า Environment Variable ใน Container
#               environmentVariables: |
#                 CONTAINER_APP_NAME: $(containerAppName)
              
#               # ตั้งค่าการให้สิทธิ์ Container App ดึง Image จาก ACR
#               # ใช้ Service Connection ชนิด AzureRM เพื่อตั้งค่า ACR Pull Secret
#               acrName: $(acrLoginServer)
#               serviceConnectionAcr: $(azureSubscription)
